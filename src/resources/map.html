<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Яндекс Карта</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=f2206a66-2fdf-432e-b948-9b64ddffc204&lang=ru_RU" type="text/javascript"></script>
    <style>
        html, body, #map {
            width: 100%; height: 100%; margin: 0; padding: 0;
        }
    </style>
</head>
<body>
<div id="map"></div>
<script>
    ymaps.ready(init);

    function init() {
        var map = new ymaps.Map("map", {
            center: [55.997054, 37.190744], // Центр Зеленограда
            zoom: 11,
            controls: ['zoomControl', 'searchControl']
        });

        // Координаты границ Зеленограда
        var zelenogradPolygonCoords = [
            [
                [56.016957, 37.140658],
                [56.018972, 37.135851],
                [56.016285, 37.131559],
                [55.999682, 37.149927],
                [55.997954, 37.149412],
                [55.996130, 37.151644],
                [55.993346, 37.153017],
                [55.992482, 37.149241],
                [55.991138, 37.149756],
                [55.991042, 37.146837],
                [55.990061, 37.144462],
                [55.978483, 37.148385],
                [55.978348, 37.146685],
                [55.973525, 37.146807],
                [55.973186, 37.143894],
                [55.972371, 37.143651],
                [55.972371, 37.145107],
                [55.969586, 37.145107],
                [55.969688, 37.146341],
                [55.967179, 37.146206],
                [55.966492, 37.145917],
                [55.966122, 37.146493],
                [55.964526, 37.147403],
                [55.962861, 37.145643],
                [55.961910, 37.147889],
                [55.960517, 37.149164],
                [55.961502, 37.150135],
                [55.961978, 37.159360],
                [55.962521, 37.159420],
                [55.961842, 37.160938],
                [55.960007, 37.161969],
                [55.958577, 37.167154],
                [55.959154, 37.167454],
                [55.958866, 37.168956],
                [55.960836, 37.168699],
                [55.959947, 37.173419],
                [55.959298, 37.173634],
                [55.957953, 37.172518],
                [55.958818, 37.177711],
                [55.958794, 37.182560],
                [55.957544, 37.185393],
                [55.960187, 37.182732],
                [55.960091, 37.181316],
                [55.960788, 37.180758],
                [55.960667, 37.178483],
                [55.962517, 37.178183],
                [55.963022, 37.182861],
                [55.958241, 37.186938],
                [55.951442, 37.218008],
                [55.953556, 37.219382],
                [55.954157, 37.217837],
                [55.955190, 37.218309],
                [55.956752, 37.210627],
                [55.959755, 37.209297],
                [55.961640, 37.205903],
                [55.965580, 37.209605],
                [55.965886, 37.208664],
                [55.968196, 37.208907],
                [55.970013, 37.207390],
                [55.969724, 37.208907],
                [55.970437, 37.209423],
                [55.971117, 37.208118],
                [55.972679, 37.210788],
                [55.975090, 37.211274],
                [55.977433, 37.218375],
                [55.977930, 37.216881],
                [55.981343, 37.219912],
                [55.981726, 37.224964],
                [55.979090, 37.242122],
                [55.974504, 37.251692],
                [55.973015, 37.252636],
                [55.972054, 37.251778],
                [55.971305, 37.254631],
                [55.968757, 37.253173],
                [55.967872, 37.258940],
                [55.972527, 37.261594],
                [55.972384, 37.269607],
                [55.974926, 37.272669],
                [55.975897, 37.269096],
                [55.980323, 37.271342],
                [55.981465, 37.269096],
                [55.983321, 37.263534],
                [55.987261, 37.264248],
                [55.988659, 37.263074],
                [55.987489, 37.256083],
                [55.988602, 37.254756],
                [55.993427, 37.260880],
                [56.021628, 37.188872],
                [56.014029, 37.159497],
                [56.018168, 37.158162],
                [56.017082, 37.148937],
                [56.016811, 37.141047],
                [56.016742, 37.141484]
            ]
        ];

        // Отрисовка границ
        var zelenogradPolygon = new ymaps.Polygon(zelenogradPolygonCoords, {
            hintContent: "Зеленоград"
        }, {
            fillColor: '#00FF0010',
            strokeColor: '#00800090',
            strokeWidth: 2
        });
        map.geoObjects.add(zelenogradPolygon);

        // Глобальные переменные для маршрутов
        var startPoint = null;
        var endPoint = null;
        var route = null;
        var startPlacemark = null;
        var endPlacemark = null;

        // Функция для геокодирования места
        function geocodePlace(place, callback) {
            ymaps.geocode(place).then(function (res) {
                var firstGeoObject = res.geoObjects.get(0);
                if (firstGeoObject) {
                    var coordinates = firstGeoObject.geometry.getCoordinates();
                    callback(coordinates);
                } else {
                    alert("Не удалось найти место: " + place);
                }
            }).catch(function (err) {
                console.error("Ошибка геокодирования:", err);
                alert("Произошла ошибка при поиске места.");
            });
        }

        // Функция для построения маршрута
        function drawRoute(startAddress, endAddress, routeType = 'auto') {
            // Очистка старого маршрута
            if (route) {
                map.geoObjects.remove(route);
                route = null;
            }

            // Сначала получаем начальную точку
            geocodePlace(startAddress, function (coordinates) {
                startPoint = coordinates;
                if (startPlacemark) {
                    startPlacemark.geometry.setCoordinates(startPoint);
                } else {
                    startPlacemark = new ymaps.Placemark(startPoint, {
                        balloonContent: "Начальная точка"
                    }, {
                        preset: 'islands#greenDotIcon'
                    });
                    map.geoObjects.add(startPlacemark);
                }

                // Получаем конечную точку, когда начальная уже определена
                geocodePlace(endAddress, function (coordinates) {
                    endPoint = coordinates;
                    if (endPlacemark) {
                        endPlacemark.geometry.setCoordinates(endPoint);
                    } else {
                        endPlacemark = new ymaps.Placemark(endPoint, {
                            balloonContent: "Конечная точка"
                        }, {
                            preset: 'islands#redDotIcon'
                        });
                        map.geoObjects.add(endPlacemark);
                    }

                    // Когда обе точки определены, строим маршрут
                    if (startPoint && endPoint) {
                        ymaps.route([startPoint, endPoint], { routingMode: routeType })
                            .then(function (newRoute) {
                                route = newRoute;
                                map.geoObjects.add(route);
                            })
                            .catch(function (error) {
                                console.error("Ошибка построения маршрута:", error);
                                alert("Не удалось построить маршрут.");
                            });
                    }
                });
            });
        }

        // Загрузка адресов и размещение меток
        fetch('addresses.txt')
            .then(response => response.text())
            .then(data => {
                var addresses = data.split('\n');
                addresses.forEach(address => {
                    if (address.trim()) {
                        ymaps.geocode(address.trim()).then(function (res) {
                            var firstGeoObject = res.geoObjects.get(0);
                            if (firstGeoObject) {
                                var coordinates = firstGeoObject.geometry.getCoordinates();
                                var placemark = new ymaps.Placemark(coordinates, {
                                    balloonContent: address
                                }, {
                                    preset: 'islands#orangeDotIcon'
                                });
                                map.geoObjects.add(placemark);
                            }
                        }).catch(err => console.error("Ошибка геокодирования адреса:", address, err));
                    }
                });
            })
            .catch(err => console.error("Ошибка загрузки файла addresses.txt:", err));

        // Обработчик сообщений для построения маршрутов
        window.addEventListener('message', function (event) {
            var data = event.data;
            if (data.type === 'route') {
                drawRoute(data.start, data.end, data.routeType || 'auto');
            }
        });
    }
</script>
</body>
</html>
