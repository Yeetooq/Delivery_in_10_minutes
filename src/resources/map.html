<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Яндекс Карта</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey=f2206a66-2fdf-432e-b948-9b64ddffc204&lang=ru_RU" type="text/javascript"></script>
    <style>
        html, body, #map {
            width: 100%; height: 100%; margin: 0; padding: 0;
        }
    </style>
</head>
<body>
<div id="map"></div>
<script>
    ymaps.ready(init);

    function init() {
        var map = new ymaps.Map("map", {
            center: [55.997054, 37.190744],
            zoom: 11,
            controls: ['zoomControl', 'searchControl']
        });

        // Глобальные переменные
        var startPoint = null;
        var endPoint = null;
        var route = null;
        var startPlacemark = null;
        var endPlacemark = null;

        // Функция для геокодирования места
        function geocodePlace(place, callback) {
            ymaps.geocode(place).then(function (res) {
                var firstGeoObject = res.geoObjects.get(0);
                if (firstGeoObject) {
                    var coordinates = firstGeoObject.geometry.getCoordinates();
                    callback(coordinates);
                } else {
                    alert("Не удалось найти место: " + place);
                }
            }, function (err) {
                console.error("Ошибка при геокодировании:", err);
                alert("Произошла ошибка при поиске места.");
            });
        }

        // Обработчик сообщения из внешнего источника
        window.addEventListener('message', function (event) {
            var data = event.data;
            if (data.type === 'route') {
                var startPlace = data.start;
                var endPlace = data.end;

                geocodePlace(startPlace, function (coordinates) {
                    startPoint = coordinates;
                    if (startPlacemark) {
                        startPlacemark.geometry.setCoordinates(startPoint);
                    } else {
                        startPlacemark = new ymaps.Placemark(startPoint, {
                            balloonContent: "Начальная точка"
                        }, {
                            preset: 'islands#greenDotIcon'
                        });
                        map.geoObjects.add(startPlacemark);
                    }
                });

                geocodePlace(endPlace, function (coordinates) {
                    endPoint = coordinates;
                    if (endPlacemark) {
                        endPlacemark.geometry.setCoordinates(endPoint);
                    } else {
                        endPlacemark = new ymaps.Placemark(endPoint, {
                            balloonContent: "Конечная точка"
                        }, {
                            preset: 'islands#redDotIcon'
                        });
                        map.geoObjects.add(endPlacemark);
                    }

                    if (startPoint && endPoint) {
                        if (route) {
                            map.geoObjects.remove(route);
                        }
                        ymaps.route([startPoint, endPoint], {
                            mapStateAutoApply: true,
                            routingMode: data.routeType || 'auto'
                        }).then(function (newRoute) {
                            route = newRoute;
                            map.geoObjects.add(route);
                        }, function (error) {
                            console.error("Ошибка построения маршрута:", error);
                            alert("Не удалось построить маршрут.");
                        });
                    }
                });
            }
        });
    }
</script>
</body>
</html>
