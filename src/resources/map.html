<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.default.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.12/leaflet-routing-machine.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <style>
        html, body, #map {
            width: 100%; height: 100%; margin: 0; padding: 0;
        }
    </style>
</head>
<body>
<div id="map"></div>

<script>
    var map = L.map('map').setView([55.997054, 37.190744], 11); // Москва, центр карты
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var startPoint = null;
    var endPoint = null;
    var routeControl = null;
    var startMarker = null;
    var endMarker = null;

    // Create a MarkerClusterGroup
    var markers = L.markerClusterGroup();

    function geocodePlace(place, callback) {
        var url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(place);
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    var coordinates = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                    callback(coordinates);
                } else {
                    alert("Не удалось найти место: " + place);
                }
            })
            .catch(error => {
                console.error("Ошибка при геокодировании:", error);
                alert("Произошла ошибка при поиске места.");
            });
    }

    window.addEventListener('message', function(event) {
        var data = event.data;
        if (data.type === 'route') {
            var startPlace = data.start;
            var endPlace = data.end;

            geocodePlace(startPlace, function(coordinates) {
                startPoint = L.latLng(coordinates);
                if (startMarker) {
                    startMarker.setLatLng(startPoint);
                } else {
                    startMarker = L.marker(startPoint).addTo(markers).bindPopup("Start Point").openPopup();
                }
            });

            geocodePlace(endPlace, function(coordinates) {
                endPoint = L.latLng(coordinates);
                if (endMarker) {
                    endMarker.setLatLng(endPoint);
                } else {
                    endMarker = L.marker(endPoint).addTo(markers).bindPopup("End Point").openPopup();
                }

                if (startPoint && endPoint) {
                    if (routeControl) {
                        map.removeControl(routeControl);
                    }
                    routeControl = L.Routing.control({
                        waypoints: [startPoint, endPoint],
                        routeWhileDragging: false,
                        router: new L.Routing.OSRMv1({
                            serviceUrl: 'https://router.project-osrm.org/route/v1',
                            profile: data.routeType || 'driving'
                        }),
                        show: false // Это скрывает панель с деталями маршрута
                    }).addTo(map);
                }
            });
        }
    });

    // Add marker clusters to the map
    map.addLayer(markers);
</script>
</body>
</html>
